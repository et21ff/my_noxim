# =============================================================================
# Workload for a Hierarchical CNN Accelerator Simulation (Final Version)
# =============================================================================
#
# 行为模型:
# 1. `delta_events` 定义了所有“自上而下”(DRAM->GLB, GLB->PEs)的主动数据推送。
#    它们是系统的“发动机”。
# 2. `command_definitions` 是一份“行为菜单”，供 PE 在完成计算后查阅。
#    `evict_payload` 字段同时定义了“回送多少Output数据”和“驱逐多少数据”。
#
# =============================================================================
topology: "HIERARCHICAL"

hierarchical_config:  
  num_levels: 3  
  connection_mode: "tree"  
  word_bits: 8  
    
  level_configs:  
    - level: 0  
      node_type: "DRAM"  
      buffer_size: 4164  
      roles: "ROLE_DRAM"  
      bandwidth: 128  
      fanouts: 1  
      routing_patterns:    
        INPUT:    
          mode: "INPUT"    
          port_groups: [[0]]  # DOWN[0] 从0开始  
        WEIGHT:    
          mode: "WEIGHT"    
          port_groups: [[0]]    
        OUTPUT:    
          mode: "OUTPUT"    
          port_groups: [[0]]    
  
    - level: 1  
      node_type: "GLB"  
      buffer_size: 4164  
      roles: "ROLE_GLB"  
      bandwidth: 128  
      fanouts: 16  
      aggregate: true  
      routing_patterns:    
        INPUT:    
          mode: "INPUT"    
          port_groups: [[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]]  # DOWN[0]到DOWN[15]  
        WEIGHT:    
          mode: "WEIGHT"    
          port_groups: [[0], [1], [2], [3], [4], [5], [6], [7],   
                        [8], [9], [10], [11], [12], [13], [14], [15]]    
        OUTPUT:    
          mode: "OUTPUT"    
          port_groups: [[0], [1], [2], [3], [4], [5], [6], [7],   
                        [8], [9], [10], [11], [12], [13], [14], [15]]    
        
    - level: 2  
      node_type: "COMPUTE"  
      buffer_size: 64    
      roles: "ROLE_BUFFER"  
      bandwidth: 8  
      fanouts: 0

buffer_depth: 8 # <--- [建议修改] 稍微调大一点，避免初始调试时因缓冲区太小而产生干扰
# size of flits, in bits
flit_size: 32
# lenght in mm of router to hub connection
r2h_link_length: 2.0
# lenght in mm of router to router connection
r2r_link_length: 1.0
n_virtual_channels: 3
# Routing algorithms:
routing_algorithm: XY # <--- 在1x1的网络里，路由算法不重要，XY即可
routing_table_filename: ""
dyad_threshold: 0.6
# ... (selection_strategy 等保持不变) ...
selection_strategy: RANDOM
# ------------------- [重要] 禁用所有不相关的特性 -------------------

# WIRELESS CONFIGURATION (禁用)
use_winoc: false
use_wirxsleep: false
# ------------------- SIMULATION PARAMETERS -------------------
#
clock_period_ps: 1000
reset_time: 10 # <--- [建议修改] 缩短reset时间，让我们的逻辑更快开始
simulation_time: 4000 # <--- [关键修改] 增加模拟时间，确保我们能看到完整的交互链
stats_warm_up_time: 0 # <--- [建议修改] 禁用warm up，我们想从一开始就看log
# power breakdown, nodes communication details
detailed: false
# stop after a given amount of load has been processed
max_volume_to_be_drained: 0
show_buffer_stats: false
# ... (detailed, max_volume_to_beROLE_DRAM_drained 等保持不变) ...

# Verbosity level:
verbose_mode: VERBOSE_OFF # <--- [关键修改] 设置为LOW，可以看到一些基本的网络活动日志

# Trace (可选，但推荐)
trace_mode: false # 如果需要详细的flit追踪，可以设为true，但日志会非常多
trace_filename: "debug_trace.log"

# ------------------- [重要] 禁用Noxim自带的流量注入 -------------------
# 我们现在用自己的逻辑生成流量，所以要把Noxim自带的流量注入率设为0

min_packet_size: 8
max_packet_size: 8
packet_injection_rate: 0.1 # <--- [关键修改] 设为0！
probability_of_retransmission: 0.1 # <--- [关键修改] 设为0！

# Traffic distribution:
# 将其设置为TABLE_BASED，但提供一个空文件，确保它不会产生任何随机流量。
traffic_distribution: TRAFFIC_TABLE_BASED # <--- [关键修改]
traffic_table_filename: "empty_traffic.txt" # <--- 创建一个空的txt文件


workload:
  working_set:
    - role: "ROLE_DRAM"
      data:
        - { data_space: "Weights", size: 3072, reuse_strategy: "resident" }
        - { data_space: "Inputs", size: 576, reuse_strategy: "resident" }
        - { data_space: "Outputs", size: 512, reuse_strategy: "resident" }
    - role: "ROLE_GLB"
      data:
        - { data_space: "Weights", size: 3072, reuse_strategy: "resident" }
        - { data_space: "Inputs", size: 576, reuse_strategy: "resident" }
        - { data_space: "Outputs", size: 512, reuse_strategy: "resident" }
    - role: "ROLE_BUFFER"
      data:
        - { data_space: "Weights", size: 1, reuse_strategy: "temporal" }
        - { data_space: "Inputs",  size: 16, reuse_strategy: "temporal" }
        - { data_space: "Outputs", size: 16, reuse_strategy: "temporal" }

  data_flow_specs:
    - role: "ROLE_DRAM"
      properties:
        sync_per_timestep: 1
      schedule_template:
        total_timesteps: 1
        delta_events:
          - trigger: { on_timestep: "default" }
            name: "INITIAL_LOAD_DRAM_TO_GLB"
            delta:
              - { data_space: "Weights", size: 3072 ,target_role: "ROLE_GLB" }
              - { data_space: "Inputs",  size: 576 ,target_role: "ROLE_GLB" }
              - { data_space: "Outputs", size: 512 ,target_role: "ROLE_GLB" }

    - role: "ROLE_GLB"
      properties:
        sync_per_timestep: 3
      schedule_template:
        total_timesteps: 192
        delta_events:
          - trigger: { on_timestep_modulo: [3, 0] }
            name: "MULTICAST_FILL_INPUTS"
            delta:
              - { data_space: "Inputs",  size: 16,target_role: "ROLE_BUFFER" }
              - { data_space: "Weights", size: 1 ,target_role: "ROLE_BUFFER" }
              - { data_space: "Outputs", size: 16, target_role: "ROLE_BUFFER" }

          - trigger: { on_timestep: "fallback" }
            name: "MULTICAST_DELTA_INPUTS_1"
            delta:
              - { data_space: "Inputs",  size: 1 ,target_role: "ROLE_BUFFER" }
              - { data_space: "Weights", size: 1 ,target_role: "ROLE_BUFFER" } 
      
      command_definitions:
        - command_id: 0
          name: "PROCESS_FULL_CONTEXT"
          evict_payload: { Weights: 3072, Inputs: 576, Outputs: 512 }

    - role: "ROLE_BUFFER"
      properties:
        compute_latency: 16
      schedule_template:
        total_timesteps: 1
        delta_events: []
      command_definitions:
        - command_id: 0
          name: "PROCESS_DELTA"
          evict_payload: { Weights: 1, Inputs: 1, Outputs: 0 }
        - command_id: 1
          name: "PROCESS_FULL_CONTEXT"
          evict_payload: { Weights: 1, Inputs: 16, Outputs: 16 }

      